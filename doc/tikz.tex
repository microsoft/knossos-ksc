\documentclass{standalone}
\usepackage{freetikz}
\usetikzlibrary{calc}
\newcommand{\F}{\mathcal{F}}
\newcommand{\FF}[1]{\F{#1}}
\newcommand{\dd}{\partial_r}
\newcommand{\ddd}[1]{\dd{#1}}
\newcommand{\tangenttype}[1]{\delta{}{#1}}
\newcommand{\tape}[1]{T_{#1}}
\begin{document}
\begin{tikzpicture}
  % f

  \node[dot,minimum size=25] (fg) at (0, 5) {$f$};
  \draw[->] ($ (fg) + (-1.5, 0) $) node[left] {$a$} to (fg);
  \draw[->] (fg) to ($ (fg) + (+1.5, 0) $) node[right] {$b$};

  \node[dot,minimum size=25] (ffg) at ($ (fg) + (5, 0) $) {$\FF{f}$};
  \node[dot,minimum size=25] (dfg) at ($ (ffg) + (0, -2) $) {$\ddd{f}$};

  \draw[->] ($ (ffg) + (-1.5, 0) $) node[left] {$a$} to (ffg);
  \draw[->] (ffg) to ($ (ffg) + (+1.5, 0) $) node[right] {$b$};

  \draw[->] ($ (dfg) + (+1.5, 0) $) node[right] {$\tangenttype{b}$} to (dfg);
  \draw[->] (dfg) to ($ (dfg) + (-1.5, 0) $) node[left] {$\tangenttype{a}$};


  \draw[->] [dashed] (ffg) to node[right] {$\tape{f}$} (dfg);


  % +

  \node[dot,minimum size=25] (plus) at (0, 0) {$+$};
  \draw[->] ($ (plus) + (-1.5, -0.5) $) to[out=0, in=-135] (plus);
  \draw[->] ($ (plus) + (-1.5, +0.5) $) to[out=0, in=+135] (plus);
  \draw[->] (plus) to ($ (plus) + (1.5, 0) $);

  \node[dot,minimum size=25] (fplus) at (5, 0) {$+$};
  \node[dot] (dup) at ($ (fplus) + (0, -2) $) {};
  \draw[->] ($ (fplus) + (-1.5, -0.5) $) to[out=0, in=-135] (fplus);
  \draw[->] ($ (fplus) + (-1.5, +0.5) $) to[out=0, in=+135] (fplus);
  \draw[->] (fplus) to ($ (fplus) + (1.5, 0) $);

  \draw[->] (dup) to[out=-135, in=0] ($ (dup) + (-1.5, -0.5) $);
  \draw[->] (dup) to[out=+135, in=0]  ($ (dup) + (-1.5, +0.5) $);
  \draw[->] ($ (dup) + (1.5, 0) $) to (dup);

  \draw[->] [dashed] (fplus) to[] node[right] {()} (dup);


  % dup


  % *

  \node[dot,minimum size=25] (mul) at ($ (plus) + (0, -5) $) {$*$};
  \draw[->] ($ (mul) + (-1.5, -0.5) $) to[out=0, in=-135] (mul);
  \draw[->] ($ (mul) + (-1.5, +0.5) $) to[out=0, in=+135] (mul);
  \draw[->] (mul) to ($ (mul) + (1.5, 0) $);

  \node[dot,minimum size=25] (fmul) at ($ (mul) + (5, 0) $) {$*$};
  \node[dot] (dupm1) at ($ (fmul) + (-1, +0.5) $) {};
  \node[dot] (dupm2) at ($ (fmul) + (-1, -0.5) $) {};

  \node[dot] (dupm) at ($ (fmul) + (0, -2) $) {};
  \node[dot,minimum size=25] (muld1) at ($ (dupm) + (-1, +0.5) $) {$*$};
  \node[dot,minimum size=25] (muld2) at ($ (dupm) + (-1, -0.5) $) {$*$};

  \draw[->] ($ (fmul) + (-1.5, +0.5) $) to (dupm1);
  \draw[->] ($ (fmul) + (-1.5, -0.5) $) to (dupm2);
  \draw[->] (dupm1) to[out=0, in=+135] (fmul);
  \draw[->] (dupm2) to[out=0, in=-135] (fmul);
  \draw[->] (fmul) to ($ (fmul) + (1.5, 0) $);


  \draw[->] (dupm) to[out=+135, in=-45] (muld1);
  \draw[->] (dupm) to[out=-135, in=-45]  (muld2);
  \draw[->] ($ (dupm) + (1.5, 0) $) to (dupm);

  \draw[->] (muld1) to ($ (muld1) + (-1, 0) $);
  \draw[->] (muld2) to ($ (muld2) + (-1, 0) $);

  \draw[->] [dashed] (dupm1) to[out=-90, in=+45]
                     ($ (muld2) + (1, 1) $) node[right] {(Float, Float)} to
                     (muld2);
  \draw[->] [dashed] (dupm2) to[out=-90, in=+45] (muld1);


  % comp

  \node[dot,minimum size=25] (fcomp1) at ($ (mul) + (-1, -5) $) {$f$};
  \node[dot,minimum size=25] (gcomp1) at ($ (fcomp1) + (2, 0) $) {$g$};

  \node[dot,minimum size=25] (fcomp) at ($ (fcomp1) + (5, 0) $) {$\F f$};
  \node[dot,minimum size=25] (gcomp) at ($ (fcomp) + (2, 0) $) {$\F g$};

  \node[dot,minimum size=25] (dfcomp) at ($ (fcomp) + (0, -2) $) {$\dd f$};
  \node[dot,minimum size=25] (dgcomp) at ($ (gcomp) + (0, -2) $) {$\dd g$};

  \draw[->] ($ (fcomp1) + (-1, 0) $) to (fcomp1);
  \draw[->] (fcomp1) to (gcomp1);
  \draw[->] (fcomp1) to ($ (gcomp1) + (1, 0) $);

  \draw[->] ($ (fcomp) + (-1, 0) $) to (fcomp);
  \draw[->] (fcomp) to (gcomp);
  \draw[->] (fcomp) to ($ (gcomp) + (1, 0) $);

  \draw[->] [dashed] (fcomp) to (dfcomp);
  \draw[->] [dashed] (gcomp) to node[right] {$(T_f, T_g)$} (dgcomp);

  \draw[->] (dfcomp) to ($ (dfcomp) + (-1, 0) $);
  \draw[->] (dgcomp) to (dfcomp);
  \draw[->] ($ (dgcomp) + (1, 0) $) to (dfcomp);


  % par

  \node[dot,minimum size=25] (fpar1) at ($ (fcomp1) + (0, -5) $) {$f$};
  \node[dot,minimum size=25] (gpar1) at ($ (fpar1) + (0.75, -0.75) $) {$g$};

  \node[dot,minimum size=25] (fpar) at ($ (fcomp) + (0, -5) $) {$\F f$};
  \node[dot,minimum size=25] (gpar) at ($ (fpar) + (0.75, -0.75) $) {$\F g$};

  \node[dot,minimum size=25] (dfpar) at ($ (fpar) + (0, -3) $) {$\dd f$};
  \node[dot,minimum size=25] (dgpar) at ($ (gpar) + (0, -3) $) {$\dd g$};

  \draw[->] ($ (fpar1) + (-1.5, 0) $) to (fpar1);
  \draw[->] (fpar1) to ($ (fpar1) + (2.5, 0) $);
  \draw[->] ($ (gpar1) + (-2.5, 0) $) to (gpar1);
  \draw[->] (gpar1) to ($ (gpar1) + (1.5, 0) $);

  \draw[->] ($ (fpar) + (-1.5, 0) $) to (fpar);
  \draw[->] (fpar) to ($ (fpar) + (2.5, 0) $);
  \draw[->] ($ (gpar) + (-2.5, 0) $) to (gpar);
  \draw[->] (gpar) to ($ (gpar) + (1.5, 0) $);

  \draw[->] [dashed] (fpar) to (dfpar);
  \draw[->] [dashed] (gpar) to node[right] {$(T_f, T_g)$} (dgpar);

  \draw[->]  (dfpar) to ($ (dfpar) + (-1.5, 0) $);
  \draw[->] ($ (dfpar) + (2.5, 0) $) to (dfpar);
  \draw[->] (dgpar) to ($ (dgpar) + (-2.5, 0) $);
  \draw[->] ($ (dgpar) + (1.5, 0) $) to (dgpar);


  % elim

  \node[dot,minimum size=25] (elim1) at ($ (fpar1) + (0, -6) $) {elim};
  \node[dot,minimum size=25] (elim) at ($ (elim1) + (5, 0) $) {elim};
  \node[dot,minimum size=25] (zero) at ($ (elim) + (0, -2) $) {zero};

  \draw[->] ($ (elim1) + (-1.5, 0) $) to (elim1);
  \draw[->] ($ (elim) + (-1.5, 0) $) to (elim);
  \draw[->] (zero) to ($ (zero) + (-1.5, 0) $);
  \draw[->] [dashed] (elim) tonode[right] {$()$}  (zero);


  % const

  \node[dot,minimum size=25] (const1) at ($ (elim1) + (0, -5) $) {const};
  \node[dot,minimum size=25] (const) at ($ (const1) + (5, 0) $) {const};
  \node[dot,minimum size=25] (elimconst) at ($ (const) + (0, -2) $) {elim};

  \draw[->] (const1) to ($ (const1) + (+1.5, 0) $);
  \draw[->] (const) to ($ (const) + (+1.5, 0) $);
  \draw[->] ($ (elimconst) + (+1.5, 0) $) to (elimconst);
  \draw[->] [dashed] (const) tonode[right] {$()$} (elimconst);


  % index

  \node[dot] (index) at ($ (const1) + (0, -5) $) {index};
  \node[dot] (findex) at ($ (index) + (6, 0) $) {index};
  \node[dot] (incAt) at ($ (findex) + (0, -2) $) {incAt};
  \node[dot] (indexdup) at ($ (findex) + (-1, +0.5) $) {};

  \draw[->] ($ (index) + (-1.5, +0.5) $) node[left] {Integer} to[out=0,in=+135] (index);
  \draw[->] ($ (index) + (-1.5, -0.5) $) node[left] {Vec $n$ $a$} to[out=0,in=-135] (index);
  \draw[->] (index) to[out=+45,in=180] ($ (index) + (+1.5, +0.5) $) node[right] {$a$};
  \draw[->] (index) to[out=-45,in=180] ($ (index) + (+1.5, -0.5) $) node[right] {Vec $n$ $a$};

  \draw[->] ($ (findex) + (-1.5, +0.5) $) node[left] {Integer} to[out=0,in=180] (indexdup);
  \draw[->] (indexdup) to[out=0,in=+135] (findex);
  \draw[->] ($ (findex) + (-1.5, -0.5) $) node[left] {Vec $n$ $a$} to[out=0,in=-135] (findex);
  \draw[->] (findex) to[out=+45,in=180] ($ (findex) + (+1.5, +0.5) $) node[right] {$a$};
  \draw[->] (findex) to[out=-45,in=180] ($ (findex) + (+1.5, -0.5) $) node[right] {Vec $n$ $a$};

  \draw[->] (incAt) to ($ (incAt) + (-1.5, 0.0) $) node[left] {$\tangenttype{}$(Vec $n$ $a$)};
  \draw[->] [dashed] (indexdup) to[out=-90,in=45] (incAt);
  \draw[->] ($ (incAt) + (+1.5,  0.0) $) node[right] {$\tangenttype{a}$} to[out=180,  in=0] (incAt);
  \draw[->] ($ (incAt) + (+1.5, -0.5) $) node[right] {$\tangenttype{}$(Vec $n$ $a$)} to[out=180,in=-45] (incAt);


  % if introduction

  \node[dot,minimum size=25] (fif) at ($ (index) + (0, -5) $) {$f$};
  \node[dot,minimum size=25] (gif) at ($ (fif) + (0, -1.5) $) {$g$};
  \node[rectangle,draw,fill=black!25] (if) at ($ (fif) + (6, 0) $) {if -- then $f$ else $g$};

  \draw[->] ($ (fif) + (-1.5, 0) $) node[left] {$a$} to (fif);
  \draw[->] (fif) to ($ (fif) + (1.5, 0) $) node[right] {$b$};
  \draw[->] ($ (gif) + (-1.5, 0) $) node[left] {$a$} to (gif);
  \draw[->] (gif) to ($ (gif) + (1.5, 0) $) node[right] {$b$};

  \draw[->] ($ (if) + (-2,+0.25) $) node[left] {Bool} to (if);
  \draw[->] ($ (if) + (-2,-0.25) $) node[left] {$a$} to (if);
  \draw[->] (if) to ($ (if) + (2, 0) $) node[right] {$b$};


  % if differentiation

  \node[rectangle,draw,fill=black!25] (ifprimal) at ($ (fif) + (0, -5) $) {if -- then $f$ else $g$};
  \node[rectangle,draw,fill=black!25] (ifforward) at ($ (ifprimal) + (6, 0) $) {if -- then $\FF{f}$ else $\FF{g}$};
  \node[rectangle,draw,fill=black!25] (ifrev) at ($ (ifforward) + (0, -2.5) $) {if -- then $\ddd{f}$ else $\ddd{g}$};

  \draw[->] ($ (ifprimal) + (-2,+0.25) $) node[left] {Bool} to (ifprimal);
  \draw[->] ($ (ifprimal) + (-2,-0.25) $) node[left] {$a$} to (ifprimal);
  \draw[->] (ifprimal) to ($ (ifprimal) + (2, 0) $) node[right] {$b$};

  \draw[->] ($ (ifforward) + (-2.5,+0.25) $) node[left] {Bool} to (ifforward);
  \draw[->] ($ (ifforward) + (-2.5,-0.25) $) node[left] {$a$} to (ifforward);
  \draw[->] (ifforward) to ($ (ifforward) + (2.5, 0) $) node[right] {$b$};

  \draw[->] (ifrev) to ($ (ifrev) + (-2.5,0) $) node[left] {$\tangenttype{a}$};
  \draw[->] ($ (ifrev) + (2.5, 0) $) node[right] {$\tangenttype{b}$} to (ifrev);

  \draw[->] [dashed] (ifforward) to[out=-90,in=10] node[right] {Either $\tape{f}$ $\tape{g}$} (ifrev);
  \draw[->] [dashed] ($ (ifforward) + (-2.5,+0.25) $) to[out=-90,in=20] node[left] {Bool} (ifrev);

  % loop introduction

  \node[dot,minimum size=25] (floop) at ($ (ifprimal) + (0, -5) $) {$f$};
  \node[rectangle,draw,fill=black!25] (loop) at ($ (floop) + (6, 0) $) {loop $f$};

  \draw[->] ($ (floop) + (-1.5, 0) $) node[left] {$a$} to (floop);
  \draw[->] (floop) to ($ (floop) + (1.5, 0) $) node[right] {$a$};

  \draw[->] ($ (loop) + (-1,+0.25) $) node[left] {Integer} to (loop);
  \draw[->] ($ (loop) + (-1,-0.25) $) node[left] {$a$} to (loop);
  \draw[->] (loop) to ($ (loop) + (1, 0) $) node[right] {$a$};


  % checkpoint

  \node[dot,minimum size=25] (nocheckf) at ($ (floop) + (0, -5) $) {$f$};
  \node[dot,minimum size=25] (nocheckdf) at ($ (nocheckf) + (0, -2) $) {$\dd f$};

  \draw[->] ($ (nocheckf) + (-1.5, 0) $) node[left] {$a$} to (nocheckf);
  \draw[->] (nocheckf) to ($ (nocheckf) + (+1.5, 0) $);
  \draw[->] ($ (nocheckdf) + (+1.5, 0) $) to (nocheckdf);
  \draw[->] (nocheckdf) to ($ (nocheckdf) + (-1.5, 0) $);

  \draw[->] [dashed] (nocheckf) tonode[right] {$T_f$} (nocheckdf);

  \node[dot,minimum size=25] (checkf) at ($ (nocheckf) + (5, 0) $) {$f$};
  \node[dot,minimum size=25] (checkfagain) at ($ (checkf) + (0, -1.5) $) {$\FF{f}$};
  \node[dot,minimum size=25] (checkdf) at ($ (checkfagain) + (0, -1.5) $) {$\dd f$};
  \node[dot] (dupcheck) at ($ (checkf) + (-1, 0) $) {};
  \node[dot,minimum size=25] (checkelim) at ($ (checkfagain) + (1.5, 0) $) {elim};

  \draw[->] ($ (checkf) + (-1.5, 0) $) node[left] {$a$} to (dupcheck);

  \draw[->] (dupcheck) to (checkf);
  \draw[->] [dashed] (dupcheck) to[out=-90,in=180] node[left] {$a$} (checkfagain);
  \draw[->] (checkfagain) to (checkelim);

  \draw[->] (checkf) to ($ (checkf) + (+1.5, 0) $);
  \draw[->] ($ (checkdf) + (1.5, 0) $) to (checkdf);
  \draw[->] (checkdf) to ($ (checkdf) + (-1.5, 0) $);

  \draw[->] (checkfagain) to node[right] {$T_f$} (checkdf);

\end{tikzpicture}
\end{document}


% https://tex.stackexchange.com/questions/48756/tikz-relative-coordinates
