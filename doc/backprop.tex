\documentclass[10pt]{article}
\usepackage{makecell,amsmath}
\usepackage[a4paper, total={6.5in, 8in}]{geometry}

\parindent=0pt
\parskip=2pt
%\renewcommand{\cellalign}{l}

\newcommand{\fn}[1]{\mathrm{#1}}
\newcommand{\vars}[1]{\mathcal{#1}}
\newcommand{\B}[1]{\mathcal{B}[#1]}
\newcommand{\dd}[1]{\delta #1}

\def\V{\vars V}

\newcommand{\typed}[3]{#1 : \vars #2 \vdash #3}
\newcommand{\typeddef}[4]{
\begin{aligned}
#1 &: \vars #2 \vdash #3 \\ 
 &= #4
\end{aligned}
}

\def\type#1:#2|-#3{\typed{#1}{#2}{#3}}

\def\Let#1=#2#3{\textrm{let}~ #1 = #2 ~\textrm{in}~ #3}
\def\LET#1=#2#3{\begin{aligned}[t] &\textrm{let}~ #1 = #2\\ &#3 \end{aligned}}
\def\LETin#1=#2#3{\LET{#1}={#2}{\textrm{in}~ #3}}

\def\LAM#1.#2{\lambda \, #1 \,.\, #2}

\begin{document}
Notation: 

An expression $e : \V \vdash T$ has free variables $\V$ and its return value is of type $T$.

The freevar list $\V$ has type $V$, which is the type of a tuple containing the vars.

A type $V$ has associated type $\dd V$ which is the tangent type of $V$.

And $A \sqcup B$ is ``exclusive union": the list $A \sqcup \{x\}$ contains $x$ exactly once.

\def\concat{\#}
And $A \concat B$ is tuple concatenation.

\bigskip

\begin{tabular}[t]{l|c|p{70mm}}
  Expression e &
  $\type e : V |- T$
  &
  $\type \B{e} : V |- {(T, \dd{V} \to \dd{T})}$ \\

  \hline

  Constant k &
       $\type k : () |- T$ &
       $\typeddef{\B{k}}{()}{(T, \dd{T} \to ())}{(k,\fn{const} \, ())}$     \\

  \hline
  Variable v &
      $\typed{v}{T}{T}$ &
      $\typeddef{\B{v}}{T}{(T, \dd{T} \to \dd{T})}{(v,\fn{id})}$  \\

  \hline

  Let&
  \makecell{
    $\typed{\Let x = {e_1}{e_2}}{V_1 \cup V_2}{T}$\\
where\\[2pt]
    $\typed{e_1}{V_1}{X}$ \\
    $\typed{e_2}{V_2 \sqcup \{x\}}{T}$\\
so\\
    $\typed{\B{e_1}}{V_1}{(X, \dd{X} \to \dd{V_1})}$ \\
    $\typed{\B{e_2}}{V_2 \sqcup \{x\}}{(T, \dd{T} \to \dd{V_2} \concat \dd{X})}$
  }
  &
  \makecell[l] {
    $\B{\Let  x_1 = {e_1}{e_2}}$ \\
    ~~$ : V_1 \cup V_2 \vdash (T, \dd{T} \to \dd(V_1) \cup \dd(V_2))$ \\
    $~~=\LET (x, b_1) = {\B{e_1}}
    {\LET (t, b_2) = {\B{e_2}}
     {\LETin b = {\LAM dt . \LET (dv_2, dx) = {b_2(dt)}
					{\LETin dv_1 = {b_1(dx)} 
					 {dv_1 \oplus dv_2}}}
	   {(t, b)}}}
    $
  }
  \\
  \hline

  Apply &
  \makecell {
    $\typed{f(e)}{V}{T}$ \\
where\\
    $\typed{e}{V}{S}$ \\
    $\typed{f}{()}{S \to T}$ \\
  }
  &
  \makecell {
    $\typed{\B{e}}{V}{(S, \dd{S} \to \dd{V})}$ \\
    $\typed{f`}{()}{S \to (T, \dd{T} \to \dd{S})}$ \\
    $\typed{\B{f(e)}}{V}{(T, \dd{T} \to \dd{V})}$ \\
    \begin{tabular}[t]{ll}
    $=$ & $\textrm{let } (s, b_1) = \B{e}$ \\
    & $\textrm{let } (t, b_2) = f`(s)$ \\
    & $\textrm{in } (t, b_1 \circ b_2)$
    \end{tabular}
  } \\
  \hline

  Def&
  \makecell {
    $\typed{e}{V}{T}$ \\
    $\textrm{def } f(v) = e$ \\
    $\typed{f}{()}{V \to T}$
  }
  &
  \makecell {
    $\typed{\B{e}}{V}{(T, \dd{V} \to \dd{T})}$ \\
    $\textrm{def } f`(v) = \B{e}$\\
    $\typed{f`}{()}{V \to (T, \dd{T} \to \dd{V})}$ 
  }
\end{tabular}

\end{document}
